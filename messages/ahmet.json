/**
 * GitHub Workshop - Mesaj DuvarÄ± (Otomatik YÃ¼kleme Ã–zellikli)
 * Bu script GitHub API kullanarak messages/ klasÃ¶rÃ¼ndeki JSON dosyalarÄ±nÄ± bulur
 * ve dinamik olarak mesaj kartlarÄ± oluÅŸturur.
 */

// âš ï¸ AYARLAR: Kendi GitHub kullanÄ±cÄ± adÄ±nÄ±zÄ± ve repo adÄ±nÄ±zÄ± buraya yazÄ±n!
const GITHUB_USERNAME = "kullanici_adiniz"; // Ã–rnek: "emin"
const REPO_NAME = "repo_adiniz";            // Ã–rnek: "github-workshop"
const BRANCH_NAME = "main";                 // Genelde 'main' veya 'master' olur

// Renk seÃ§enekleri
const COLORS = ["purple", "pink", "blue", "green", "orange", "cyan"];

// EÄŸer API Ã§alÄ±ÅŸmazsa (limit dolarsa) gÃ¶sterilecek varsayÄ±lan dosya
const FALLBACK_FILES = ["ornek.json"];

/**
 * Rastgele renk seÃ§er
 */
function getRandomColor() {
  return COLORS[Math.floor(Math.random() * COLORS.length)];
}

/**
 * GitHub ikonunu SVG olarak dÃ¶ndÃ¼rÃ¼r
 */
function getGitHubIcon() {
  return `<svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
        <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
    </svg>`;
}

/**
 * Mesaj verisinden HTML kart oluÅŸturur
 */
function createMessageCard(data) {
  const card = document.createElement("article");
  card.className = "message-card";
  card.setAttribute("data-color", data.color || getRandomColor());

  const emoji = data.emoji || "ğŸ’¬";
  const name = data.name || "Anonim";
  const message = data.message || "Mesaj yok";
  const github = data.github || "";

  card.innerHTML = `
        <div class="card-emoji">${emoji}</div>
        <h3 class="card-name">${escapeHtml(name)}</h3>
        <p class="card-message">${escapeHtml(message)}</p>
        ${
          github
            ? `
            <a href="https://github.com/${escapeHtml(github)}" class="card-github" target="_blank">
                ${getGitHubIcon()}
                @${escapeHtml(github)}
            </a>
        `
            : ""
        }
    `;
  return card;
}

/**
 * HTML Ã¶zel karakterlerini escape eder (XSS korumasÄ±)
 */
function escapeHtml(text) {
  if (!text) return "";
  const div = document.createElement("div");
  div.textContent = text;
  return div.innerHTML;
}

/**
 * GitHub API kullanarak messages klasÃ¶rÃ¼ndeki dosyalarÄ± listeler
 */
async function getMessageFilesFromGitHub() {
  const apiUrl = `https://api.github.com/repos/${GITHUB_USERNAME}/${REPO_NAME}/contents/messages?ref=${BRANCH_NAME}`;
  
  try {
    const response = await fetch(apiUrl);
    
    // API limitine takÄ±lÄ±rsak veya hata alÄ±rsak
    if (!response.ok) {
      console.warn("GitHub API hatasÄ± (Muhtemelen limit aÅŸÄ±ldÄ± veya repo bilgisi yanlÄ±ÅŸ). Manuel listeye dÃ¶nÃ¼lÃ¼yor.");
      return FALLBACK_FILES;
    }

    const files = await response.json();
    
    // Sadece .json ile biten dosyalarÄ± filtrele
    return files
      .filter(file => file.name.endsWith('.json'))
      .map(file => file.name);
      
  } catch (error) {
    console.error("Dosya listesi alÄ±namadÄ±:", error);
    return FALLBACK_FILES;
  }
}

/**
 * Tek bir mesaj dosyasÄ±nÄ± yÃ¼kler
 */
async function loadMessageFile(filename) {
  try {
    // Cache'i Ã¶nlemek iÃ§in timestamp ekliyoruz
    const response = await fetch(`messages/${filename}?t=${new Date().getTime()}`);
    if (!response.ok) return null;
    return await response.json();
  } catch (error) {
    console.warn(`JSON parse hatasÄ±: ${filename}`, error);
    return null;
  }
}

/**
 * TÃ¼m mesajlarÄ± yÃ¼kler ve gÃ¶rÃ¼ntÃ¼ler
 */
async function loadAllMessages() {
  const container = document.getElementById("dynamic-messages");
  if (!container) return;

  container.innerHTML = '<div class="empty-state loading"><p>Mesajlar taranÄ±yor...</p></div>';

  // 1. Dosya listesini API'den al
  const files = await getMessageFilesFromGitHub();
  console.log("YÃ¼klenecek dosyalar:", files);

  const messages = [];

  // 2. Her dosyayÄ± tek tek Ã§ek
  for (const filename of files) {
    const data = await loadMessageFile(filename);
    if (data) {
      messages.push(data);
    }
  }

  // 3. Container'Ä± temizle ve kartlarÄ± ekle
  container.innerHTML = "";

  if (messages.length === 0) {
    container.innerHTML = `
            <div class="empty-state">
                <p>HenÃ¼z mesaj bulunamadÄ± veya repo ayarlarÄ± yanlÄ±ÅŸ.</p>
            </div>
        `;
    return;
  }

  // KartlarÄ± ekle
  messages.forEach((data, index) => {
    const card = createMessageCard(data);
    card.style.animationDelay = `${index * 0.1}s`;
    container.appendChild(card);
  });
}

function colorizeStaticCards() {
  const staticCards = document.querySelectorAll("#messages-container .message-card");
  staticCards.forEach((card) => {
    if (!card.getAttribute("data-color")) {
      card.setAttribute("data-color", getRandomColor());
    }
  });
}

document.addEventListener("DOMContentLoaded", () => {
  colorizeStaticCards();
  loadAllMessages();
});     //  Eski: const MESSAGE_FILES = ["ornek.json"]; (Sadece buraya yazÄ±lanlar yÃ¼kleniyordu).
Yeni: GITHUB_USERNAME ve REPO_NAME deÄŸiÅŸkenleri eklendi. ArtÄ±k dosya isimlerini elle yazmÄ±yoruz, script gidip depoya (repository) bakÄ±yor.
